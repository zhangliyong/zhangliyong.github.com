<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8">
        <title>Lyon's Blog</title>
        <link rel="stylesheet" href="./theme/css/main.css">
                
        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="./">Lyon's Blog </a></h1>
                <nav><ul>
                                                    <li><a href="./pages/about.html">About</a></li>
                                                                    <li ><a href="./category/algorithm.html">algorithm</a></li>
                                    <li ><a href="./category/bash.html">bash</a></li>
                                    <li ><a href="./category/db.html">db</a></li>
                                    <li ><a href="./category/git.html">git</a></li>
                                    <li ><a href="./category/linux.html">linux</a></li>
                                    <li ><a href="./category/misc.html">misc</a></li>
                                    <li ><a href="./category/mongo.html">mongo</a></li>
                                    <li ><a href="./category/munin.html">munin</a></li>
                                    <li ><a href="./category/mysql.html">mysql</a></li>
                                    <li ><a href="./category/network.html">network</a></li>
                                    <li ><a href="./category/nginx.html">nginx</a></li>
                                    <li ><a href="./category/python.html">python</a></li>
                                    <li ><a href="./category/vim.html">vim</a></li>
                                                </ul></nav>
        </header><!-- /#banner -->
                
            

                            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="./locale.html">locale</a></h1> 
                    <footer class="post-info">
        <abbr class="published" title="2013-08-08T13:40:59">
                Thu 08 August 2013
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="./author/zhang-liyong.html">zhang liyong</a>
        </address>
        <p>In <a href="./category/linux.html">linux</a>. </p>

</footer><!-- /.post-info --><p>当在终端下执行某些操作，提示编码问题时，基本是因为终端的locale环境的编码不支持。</p>
<p>有些终端下默认的LC_*设置为<code>C</code>，可运行<code>locale</code>查看，此时终端环境的默认编码是<code>ASCII</code>。</p>
<p>可将其改为<code>UTF8</code>编码。</p>
<p>修改方式如下：</p>
<ol>
<li>用<code>locale -a</code>命令查看系统支持的category。</li>
<li>在终端下进行<code>export LANG=&lt;category&gt;</code>，此时终端的<code>LC_*</code>变量发生了变化。
    如果不想每次手动设置，可将<code>export LANG=&lt;category&gt;</code>加到<code>.bashrc</code>中。</li>
</ol>                </article>
                            </aside><!-- /#featured -->
                            <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">
                                                

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="./find-out-which-process-open-a-linux-port.html" rel="bookmark"
                           title="Permalink to Find out which process open a linux port">Find out which process open a linux port</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2013-08-08T13:13:35">
                Thu 08 August 2013
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="./author/zhang-liyong.html">zhang liyong</a>
        </address>
        <p>In <a href="./category/linux.html">linux</a>. </p>

</footer><!-- /.post-info -->                <p>最近在调mongodb的性能，发现currentop中有很多长时间运行的查询，从currentop中可以看到查询来源ip:port。</p>
<p>那么可以到ip机器上查询port对应的进程号，进而找到发出此查询的应用。</p>
<p>根据port来查询进程号有多种方案：
1. netstat， <code>sudo netstat -anp | grep &lt;port&gt;</code></p>
<div class="highlight"><pre><span class="err">关于</span><span class="n">netstat</span><span class="err">的使用参考：</span><span class="n">http</span><span class="o">:</span><span class="c1">//www.thegeekstuff.com/2010/03/netstat-command-examples/</span>
</pre></div>


<ol>
<li>
<p>fuser，找到使用tcp 7000端口号的进程：<code>sudo fuser 7000/tcp</code></p>
</li>
<li>
<p>lsof</p>
<div class="highlight"><pre><span class="n">lsof</span> <span class="o">-</span><span class="n">i</span> <span class="o">:</span><span class="n">portNumber</span>
<span class="n">lsof</span> <span class="o">-</span><span class="n">i</span> <span class="n">tcp</span><span class="o">:</span><span class="n">portNumber</span>
<span class="n">lsof</span> <span class="o">-</span><span class="n">i</span> <span class="n">udp</span><span class="o">:</span><span class="n">portNumber</span>
<span class="n">lsof</span> <span class="o">-</span><span class="n">i</span> <span class="o">:</span><span class="mi">80</span>
</pre></div>


</li>
</ol>
<p>通过这几种方式找到进程号后，可以利用<code>ps -eaf ...</code></p>
                <a class="readmore" href="./find-out-which-process-open-a-linux-port.html">read more</a>
                                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="./pudb.html" rel="bookmark"
                           title="Permalink to PuDB">PuDB</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2013-08-06T10:31:12">
                Tue 06 August 2013
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="./author/zhang-liyong.html">zhang liyong</a>
        </address>
        <p>In <a href="./category/python.html">python</a>. </p>

</footer><!-- /.post-info -->                <p>https://pypi.python.org/pypi/pudb</p>
                <a class="readmore" href="./pudb.html">read more</a>
                                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="./transfer-munin-server.html" rel="bookmark"
                           title="Permalink to transfer munin server">transfer munin server</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2013-08-05T13:27:23">
                Mon 05 August 2013
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="./author/zhang-liyong.html">zhang liyong</a>
        </address>
        <p>In <a href="./category/munin.html">munin</a>. </p>

</footer><!-- /.post-info -->                <p>当修改某一node的主机名时，修改后此node的所有历史记录都会消失，可以恢复这些历史数据，在munin中所有数据都保存在rrd文件中，此文件在/var/lib/munin中，如：social/services.social-uptime-uptime-g.rrd 是主机名为services.social的其中一个数据文件。当修改了node的主机名时，只需要同时对数据文件重命名即可。</p>
<ol>
<li>取消munin crontab的执行， cd /etc/cron.d/; sudo mv munin munin.disable
    crontab不会执行/etc/cron.d/下文件名中带有“.”的文件</li>
<li>生命名数据文件</li>
<li>修改munin配置/etc/munin/munin.conf中的node主机名</li>
<li>修改munin crontab执行，5分钟后将会看到更新的结果。</li>
</ol>
<p><strong>NOTE</strong>： 改动数据文件前要先取消crontab的执行，否则可能会影响历史数据, 同时数据文件迁移之后，要保证用户munin有对这些rrd文件写的权限。因为用<code>sudo ...</code></p>
                <a class="readmore" href="./transfer-munin-server.html">read more</a>
                                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="./munin.html" rel="bookmark"
                           title="Permalink to munin">munin</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2013-08-05T13:17:46">
                Mon 05 August 2013
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="./author/zhang-liyong.html">zhang liyong</a>
        </address>
        <p>In <a href="./category/munin.html">munin</a>. </p>

</footer><!-- /.post-info -->                <h2>Writing plugins</h2>
<p>global attribute: http://munin-monitoring.org/wiki/protocol-config</p>
<p>redis munin 有改动，总是说Redis找不到，一会儿一下问题，做一个patch</p>
<p>mulitgraph: http://munin-monitoring.org/wiki/protocol-multigraph</p>
<h2>fw_conntract fw_forwarded_local timeout</h2>
<p>配置好munin之后，fw_conntrack总是报警，读不到数据，主要原因是执行fw_conntrack超时，munin plugin的默认超时时间是10s，超时主要是因为<code>cat /proc/net/ip_conntrack</code>，对于网络请求少的服务器，此语句会很快执行完，但对于网络请求比较多的服务器，此语句耗时可能要超过30s。</p>
<p>Google的相应问题，此问题早已被人解决，解决方案见如下链接：
http://bugs.debian.org/cgi-bin/bugreport.cgi?bug ...</p>
                <a class="readmore" href="./munin.html">read more</a>
                                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="./fabric.html" rel="bookmark"
                           title="Permalink to fabric">fabric</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2013-07-31T11:19:32">
                Wed 31 July 2013
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="./author/zhang-liyong.html">zhang liyong</a>
        </address>
        <p>In <a href="./category/python.html">python</a>. </p>

</footer><!-- /.post-info -->                <p>下面介绍python下的一个用于项目部署的工具<a href="http://docs.fabfile.org/">fabric</a>，要学习fabric推荐阅读其官方文档，</p>
<p>本文给只给出一个简单的介绍及一些基本的功能。</p>
<p>根据官方文档的介绍:</p>
<blockquote>
<p>Fabric is:</p>
<p>A tool that lets you execute arbitrary Python functions via the command line;
A library of subroutines (built on top of a lower-level library) to make executing shell commands over SSH easy and Pythonic.</p>
</blockquote>
<p>首先安装fabric <code>pip install fabric</code>，安装完fabric之后，系统会多出fab命令。</p>
<p>fab命令在执行时会读取当前目录下的fabfile.py文件，并根据fabric的参数来执行文件中的函数 ...</p>
                <a class="readmore" href="./fabric.html">read more</a>
                                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="./how-mongodb-use-memory.html" rel="bookmark"
                           title="Permalink to How mongodb use memory">How mongodb use memory</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2013-07-29T15:11:21">
                Mon 29 July 2013
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="./author/zhang-liyong.html">zhang liyong</a>
        </address>
        <p>In <a href="./category/mongo.html">mongo</a>. </p>

</footer><!-- /.post-info -->                <p>网络上经常有文章说mongo会需要大量内存，那么mongo到低需要多少内存。</p>
<p>MongoDB实际需要的内存大小取决于working set的大小，working set是mongo完成操作所需要的所有文档及索引。对于一个collection而言，如果不需要访问每一条记录，不需要所有的记录都在内存中。working set最好都在内存中，以保证好的性能，如果不都在内存中会出现比较多的page fault。</p>
<p>查看working set大小可用如下命令：<code>db.runCommand( { serverStatus: 1, workingSet: 1 } )</code></p>
<p>serverStatus.mem.resident
The value of resident is roughly equivalent to the amount of RAM, in megabytes (MB), currently used by the database process. In normal use this ...</p>
                <a class="readmore" href="./how-mongodb-use-memory.html">read more</a>
                                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="./htop-command.html" rel="bookmark"
                           title="Permalink to htop command">htop command</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2013-07-28T11:11:13">
                Sun 28 July 2013
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="./author/zhang-liyong.html">zhang liyong</a>
        </address>
        <p>In <a href="./category/linux.html">linux</a>. </p>

</footer><!-- /.post-info -->                <p>推荐一个代替工具htop，显示信息很详细，功能丰富，一但上手操作也很简单，
<a href="http://www.thegeekstuff.com/2011/09/linux-htop-examples/">thegeekstuff</a>上有
一篇文章专门介绍了这一工具，正如这篇文章上说的：你一但开始即用htop，就不再回到top了。</p>
                <a class="readmore" href="./htop-command.html">read more</a>
                                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="./vmstat.html" rel="bookmark"
                           title="Permalink to vmstat">vmstat</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2013-07-25T11:35:02">
                Thu 25 July 2013
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="./author/zhang-liyong.html">zhang liyong</a>
        </address>
        <p>In <a href="./category/linux.html">linux</a>. </p>

</footer><!-- /.post-info -->                <p>最近在分析mongo的性能问题，发现mongo所在机器的io比较频繁。</p>
<p>使用vmstat命令查看，发现b（The number of processes in uninterruptible sleep）这一列的数量比较大，持续在4左右。
随后查询uninterruptible sleep状态的意义，引自：http://www.novell.com/support/kb/doc.php?id=7002725</p>
<blockquote>
<p>Processes in a "D" or uninterruptible sleep state are usually waiting on I/O. The ps command shows a "D" on processes in an ...</p></blockquote>
                <a class="readmore" href="./vmstat.html">read more</a>
                                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="./mongo-performance.html" rel="bookmark"
                           title="Permalink to Mongo Performance">Mongo Performance</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2013-07-25T10:07:12">
                Thu 25 July 2013
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="./author/zhang-liyong.html">zhang liyong</a>
        </address>
        <p>In <a href="./category/mongo.html">mongo</a>. </p>

</footer><!-- /.post-info -->                <p>最近mongo的性能</p>
                <a class="readmore" href="./mongo-performance.html">read more</a>
                                </div><!-- /.entry-content -->
            </article></li>
                            </ol><!-- /#posts-list -->
                            <p class="paginator">
        Page 1 / 5
            <a href="./index2.html">&raquo;</a>
    </p>
                        </section><!-- /#content -->
                    <section id="extras" class="body">
                        <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                                                    <li><a href="http://docs.notmyidea.org/alexis/pelican/">Pelican</a></li>
                                                    <li><a href="http://python.org">Python.org</a></li>
                                                    <li><a href="http://jinja.pocoo.org">Jinja2</a></li>
                                                    <li><a href="#">You can modify those links in your config file</a></li>
                                                </ul>
                </div><!-- /.blogroll -->
                                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://zhangliyong.github.com/None" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            
                                                    <li><a href="#">You can add links in your config file</a></li>
                                                    <li><a href="#">Another social link</a></li>
                                                </ul>
                </div><!-- /.social -->
                </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>