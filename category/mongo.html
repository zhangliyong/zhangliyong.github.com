<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8">
        <title>Lyon's Blog - mongo</title>
        <link rel="stylesheet" href="../theme/css/main.css">
                
        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../">Lyon's Blog </a></h1>
                <nav><ul>
                                                    <li><a href="../pages/about.html">About</a></li>
                                                                    <li ><a href="../category/algorithm.html">algorithm</a></li>
                                    <li ><a href="../category/bash.html">bash</a></li>
                                    <li ><a href="../category/db.html">db</a></li>
                                    <li ><a href="../category/emacs.html">emacs</a></li>
                                    <li ><a href="../category/git.html">git</a></li>
                                    <li ><a href="../category/linux.html">linux</a></li>
                                    <li ><a href="../category/misc.html">misc</a></li>
                                    <li class="active"><a href="../category/mongo.html">mongo</a></li>
                                    <li ><a href="../category/munin.html">munin</a></li>
                                    <li ><a href="../category/mysql.html">mysql</a></li>
                                    <li ><a href="../category/network.html">network</a></li>
                                    <li ><a href="../category/nginx.html">nginx</a></li>
                                    <li ><a href="../category/python.html">python</a></li>
                                    <li ><a href="../category/vim.html">vim</a></li>
                                                </ul></nav>
        </header><!-- /#banner -->
                
            

                            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="../how-mongodb-use-memory.html">How mongodb use memory</a></h1> 
                    <footer class="post-info">
        <abbr class="published" title="2013-07-29T15:11:21">
                Mon 29 July 2013
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/zhang-liyong.html">zhang liyong</a>
        </address>
        <p>In <a href="../category/mongo.html">mongo</a>. </p>

</footer><!-- /.post-info --><p>网络上经常有文章说mongo会需要大量内存，那么mongo到低需要多少内存。</p>
<p>MongoDB实际需要的内存大小取决于working set的大小，working set是mongo完成操作所需要的所有文档及索引。对于一个collection而言，如果不需要访问每一条记录，不需要所有的记录都在内存中。working set最好都在内存中，以保证好的性能，如果不都在内存中会出现比较多的page fault。</p>
<p>查看working set大小可用如下命令：<code>db.runCommand( { serverStatus: 1, workingSet: 1 } )</code></p>
<p>serverStatus.mem.resident
The value of resident is roughly equivalent to the amount of RAM, in megabytes (MB), currently used by the database process. In normal use this value tends to grow. In dedicated database servers this number tends to approach the total amount of system memory.</p>
<p>所以如果resident没有超出总的内存大小，此时内存是足够的，当然也要看一下page faults是不是很频繁。</p>
<p>Does MongoDB require a lot of RAM?
Not necessarily. It’s certainly possible to run MongoDB on a machine with a small amount of free RAM.</p>
<p>MongoDB automatically uses all free memory on the machine as its cache. System resource monitors show that MongoDB uses a lot of memory, but its usage is dynamic. If another process suddenly needs half the server’s RAM, MongoDB will yield cached memory to the other process.</p>
<p>Technically, the operating system’s virtual memory subsystem manages MongoDB’s memory. This means that MongoDB will use as much free memory as it can, swapping to disk as needed. Deployments with enough memory to fit the application’s working data set in RAM will achieve the best performance.</p>                </article>
                            </aside><!-- /#featured -->
                            <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">
                                                

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../mongo-performance.html" rel="bookmark"
                           title="Permalink to Mongo Performance">Mongo Performance</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2013-07-25T10:07:12">
                Thu 25 July 2013
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/zhang-liyong.html">zhang liyong</a>
        </address>
        <p>In <a href="../category/mongo.html">mongo</a>. </p>

</footer><!-- /.post-info -->                <p>最近mongo的性能</p>
                <a class="readmore" href="../mongo-performance.html">read more</a>
                                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../mongo.html" rel="bookmark"
                           title="Permalink to Mongo">Mongo</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2013-07-24T17:36:09">
                Wed 24 July 2013
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/zhang-liyong.html">zhang liyong</a>
        </address>
        <p>In <a href="../category/mongo.html">mongo</a>. </p>

</footer><!-- /.post-info -->                <h2>query after update slow</h2>
<p>这两天有一个接口的速度非常慢，主要是执行一条查询语句非常慢，有时耗时达200秒，于是找到了这条查询语句单独在mongo shell中执行，在mongo shell中执行并不慢，慢慢调试后最终找到问题，原因是在查询语句执行之前执行了两次更新语句。</p>
<p>利用pymongo执行更新时，如果不设置safe=True，mongo会及时返回函数调用，但更新并没有真正执行完，mongo进程在后台继续执行，所以当接着执行查询时，此时更新没有结束，数据库会处于lock状态，查询等待数据库解锁，所以查询非常慢。</p>
<p>把更新语句去除后，查询恢复正常。</p>
<h2>Concurrency</h2>
<p>MongoDB global lock to ga</p>
<h2>Tips</h2>
<h3>If Write Heavy</h3>
<p>Global Lock is Global
As you probably know, MongoDB has a global lock. The ...</p>
                <a class="readmore" href="../mongo.html">read more</a>
                                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../mongodb-numa-dao-zhi-de-xing-neng-wen-ti.html" rel="bookmark"
                           title="Permalink to Mongodb NUMA 导致的性能问题">Mongodb NUMA 导致的性能问题</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2013-05-08T13:45:46">
                Wed 08 May 2013
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/zhang-liyong.html">zhang liyong</a>
        </address>
        <p>In <a href="../category/mongo.html">mongo</a>. </p>

</footer><!-- /.post-info -->                <p>最近升级了mongodb，用mongo连接mongod后出现如下warning:</p>
<div class="highlight"><pre><span class="n">Server</span> <span class="n">has</span> <span class="n">startup</span> <span class="n">warnings</span><span class="o">:</span>
<span class="n">Mon</span> <span class="n">Oct</span> <span class="mi">29</span> <span class="mi">14</span><span class="o">:</span><span class="mi">45</span><span class="o">:</span><span class="mi">23</span> <span class="p">[</span><span class="n">initandlisten</span><span class="p">]</span>
<span class="n">Mon</span> <span class="n">Oct</span> <span class="mi">29</span> <span class="mi">14</span><span class="o">:</span><span class="mi">45</span><span class="o">:</span><span class="mi">23</span> <span class="p">[</span><span class="n">initandlisten</span><span class="p">]</span> <span class="o">**</span> <span class="n">WARNING</span><span class="o">:</span> <span class="n">You</span> <span class="n">are</span> <span class="n">running</span> <span class="n">on</span> <span class="n">a</span> <span class="n">NUMA</span> <span class="n">machine</span><span class="p">.</span>
<span class="n">Mon</span> <span class="n">Oct</span> <span class="mi">29</span> <span class="mi">14</span><span class="o">:</span><span class="mi">45</span><span class="o">:</span><span class="mi">23</span> <span class="p">[</span><span class="n">initandlisten</span><span class="p">]</span> <span class="o">**</span>          <span class="n">We</span> <span class="n">suggest</span> <span class="n">launching</span> <span class="n">mongod</span> <span class="n">like</span> <span class="n">this</span> <span class="n">to</span> <span class="n">avoid</span> <span class="n">performance</span> <span class="n">problems</span><span class="o">:</span>
<span class="n">Mon</span> <span class="n">Oct</span> <span class="mi">29</span> <span class="mi">14</span><span class="o">:</span><span class="mi">45 ...</span></pre></div>
                <a class="readmore" href="../mongodb-numa-dao-zhi-de-xing-neng-wen-ti.html">read more</a>
                                </div><!-- /.entry-content -->
            </article></li>
                            </ol><!-- /#posts-list -->
                            <p class="paginator">
        Page 1 / 1
    </p>
                        </section><!-- /#content -->
                    <section id="extras" class="body">
                        <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                                                    <li><a href="http://docs.notmyidea.org/alexis/pelican/">Pelican</a></li>
                                                    <li><a href="http://python.org">Python.org</a></li>
                                                    <li><a href="http://jinja.pocoo.org">Jinja2</a></li>
                                                    <li><a href="#">You can modify those links in your config file</a></li>
                                                </ul>
                </div><!-- /.blogroll -->
                                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://zhangliyong.github.com/None" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            
                                                    <li><a href="#">You can add links in your config file</a></li>
                                                    <li><a href="#">Another social link</a></li>
                                                </ul>
                </div><!-- /.social -->
                </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>